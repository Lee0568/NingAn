<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>员工管理系统 - WebRTC 采集登录蜜罐</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', Arial, 'Microsoft YaHei', sans-serif;
            background: radial-gradient(1200px circle at 10% 10%, #0f172a 0%, #111827 40%, #0b1021 100%);
            color: #e5e7eb;
            min-height: 100vh;
            margin: 0;
            display: grid;
            grid-template-rows: auto 1fr auto;
        }
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(8px);
        }
        header .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        header .brand .logo {
            width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, #60a5fa, #34d399);
            display: grid; place-items: center;
        }
        main { display: grid; place-items: center; padding: 40px 20px; }
        .layout { display: grid; grid-template-columns: 420px 520px; gap: 28px; align-items: start; }
        .card {
            background: #0b1021;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
        }
        .login-card { padding: 28px 32px; }
        .login-card h2 { margin: 0 0 16px; font-size: 22px; color: #f3f4f6; }
        .sub { color: #9ca3af; margin-bottom: 22px; font-size: 13px; }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 8px; color: #cbd5e1; font-weight: 600; font-size: 13px; }
        input[type="text"], input[type="password"] {
            width: 100%; box-sizing: border-box; padding: 12px 14px; border: 1px solid #1f2937; border-radius: 10px;
            background: #0a0f1d; color: #e5e7eb; outline: none; transition: border-color .2s, box-shadow .2s;
        }
        input[type="text"]:focus, input[type="password"]:focus {
            border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.15);
        }
        button {
            width: 100%; padding: 12px 14px; border: none; border-radius: 10px; background: linear-gradient(135deg,#2563eb,#7c3aed);
            color: #fff; font-weight: 700; cursor: pointer; transition: transform .15s ease, filter .2s ease; letter-spacing: .2px;
        }
        button:hover { transform: translateY(-1px); filter: brightness(1.05); }
        .status-bar {
            display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 18px;
        }
        .badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 10px; font-size: 12px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.08); }
        .badge .dot { width: 8px; height: 8px; border-radius: 50%; }
        .ok { background: rgba(16,185,129,0.12); color: #a7f3d0; border-color: rgba(16,185,129,0.25); }
        .ok .dot { background: #10b981; }
        .warn { background: rgba(245,158,11,0.12); color: #fde68a; border-color: rgba(245,158,11,0.25); }
        .warn .dot { background: #f59e0b; }
        .ip-card { padding: 22px 24px; }
        .ip-card h3 { margin: 0 0 12px; font-size: 18px; color: #f3f4f6; }
        .ip-list { list-style: none; padding-left: 0; margin: 0; }
        .ip-list li { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed rgba(255,255,255,0.08); }
        .ip-type { color: #93c5fd; }
        .ip-address { font-weight: 700; color: #e5e7eb; }
        footer { color: #6b7280; font-size: 12px; text-align: center; padding: 14px; }
        .toast-message { position: fixed; top: 16px; right: 16px; background: #b91c1c; color: #fff; padding: 12px 16px; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.35); opacity: 1; transition: opacity .35s ease, transform .35s ease; }
        .toast-message.hide { opacity: 0; transform: translateY(-6px); }
    </style>
    <script>
        const backendLoginUrl = 'http://127.0.0.1:65535/api/httplog/userInfo';
        const webrtcRealIpUrl = 'http://127.0.0.1:65535/api/webrtc/realip';
        const webrtcIpLogUrl = 'http://127.0.0.1:65535/api/webrtc/iplog';

        function showToast(message, duration = 2800) {
            const existing = document.querySelector('.toast-message');
            if (existing) existing.remove();
            const el = document.createElement('div');
            el.className = 'toast-message';
            el.textContent = message;
            document.body.appendChild(el);
            setTimeout(() => { el.classList.add('hide'); el.addEventListener('transitionend', () => el.remove(), { once: true }); }, duration);
        }

        async function getCanvasFingerprint() {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const text = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ`~1!2@3#4$5%6^7&8*9(0)-_=+[{]}\\|;:\'",<.>/?';
                ctx.textBaseline = 'top';
                ctx.font = '14px "Arial"';
                ctx.textBaseline = 'alphabetic';
                ctx.fillStyle = '#f60';
                ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = '#069';
                ctx.fillText(text, 2, 15);
                ctx.fillStyle = 'rgba(102, 204, 0, 0.2)';
                ctx.fillText(text, 4, 17);
                const dataUrl = canvas.toDataURL();
                const encoder = new TextEncoder();
                const data = encoder.encode(dataUrl);
                window.crypto.subtle.digest('SHA-256', data).then(buf => {
                    const arr = Array.from(new Uint8Array(buf));
                    const hex = arr.map(b => b.toString(16).padStart(2, '0')).join('');
                    resolve(hex);
                }).catch(() => resolve(null));
            });
        }

        function markStatus(id, ok, textOk, textWarn) {
            const el = document.getElementById(id);
            el.classList.remove('ok','warn');
            el.classList.add(ok ? 'ok' : 'warn');
            el.querySelector('.label').textContent = ok ? textOk : textWarn;
        }

        async function collectAndSendIps(canvasId) {
            const ipRecords = [];
            // 远端 IP（XFF/CDN）
            try {
                const resp = await fetch(webrtcRealIpUrl);
                const json = await resp.json();
                const ip = json.ip || 'Unknown';
                document.getElementById('xffIp').textContent = ip;
                ipRecords.push({ type: 'XFF or CDN IP Address', address: ip });
                markStatus('status-xff', true, '远端 IP 获取成功', '远端 IP 未获取');
            } catch (e) {
                markStatus('status-xff', false, '远端 IP 获取成功', '远端 IP 未获取');
            }

            // WebRTC IPs
            const iceServers = [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
            ];
            const pc = new RTCPeerConnection({ iceServers });
            pc.createDataChannel("");
            pc.createOffer().then(offer => pc.setLocalDescription(offer));
            const ipv4Regex = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            const ipv6Regex = /^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}(([0-9a-fA-F]{1,4}:){1,4}|((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;
            const seen = new Set();
            let webrtcAnyOk = false;
            pc.onicecandidate = function(event) {
                if (event.candidate && event.candidate.candidate) {
                    const parts = event.candidate.candidate.split(' ');
                    const ip = parts[4];
                    if (seen.has(ip)) return; seen.add(ip);
                    if (ipv4Regex.test(ip)) {
                        document.getElementById('ipv4Ip').textContent = ip;
                        ipRecords.push({ type: 'WebRTC IPv4 Address', address: ip });
                    } else if (ipv6Regex.test(ip)) {
                        document.getElementById('ipv6Ip').textContent = ip;
                        ipRecords.push({ type: 'WebRTC IPv6 Address', address: ip });
                    } else {
                        document.getElementById('localIp').textContent = ip;
                        ipRecords.push({ type: 'WebRTC Local IP Address', address: ip });
                    }
                    webrtcAnyOk = true;
                    markStatus('status-webrtc', true, 'WebRTC 获取成功', 'WebRTC 未获取');
                    sendIpLog(canvasId, ipRecords);
                }
            };
            // 初次批量上报（远端 IP）
            sendIpLog(canvasId, ipRecords);
            // 若一段时间仍未获取到 WebRTC，给出提示
            setTimeout(() => {
                if (!webrtcAnyOk) markStatus('status-webrtc', false, 'WebRTC 获取成功', 'WebRTC 未获取');
            }, 3500);
        }

        function sendIpLog(canvasId, ipRecords) {
            const payload = {
                canvasId,
                ips: ipRecords,
                method: 'GET',
                path: window.location.pathname,
                headers: JSON.stringify({ 'User-Agent': navigator.userAgent }),
                time: new Date().toISOString()
            };
            fetch(webrtcIpLogUrl, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            }).catch(() => {});
        }

        function handleLogin() {
            const form = document.getElementById('loginForm');
            form.addEventListener('submit', (event) => {
                event.preventDefault();
                getCanvasFingerprint().then(canvasId => {
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    const dataToSend = {
                        username, password, canvasId,
                        method: 'POST', path: window.location.pathname, parameter: '',
                        headers: JSON.stringify({ 'User-Agent': navigator.userAgent, 'Content-Type': 'application/json', 'Accept': 'application/json' }),
                        body: JSON.stringify({ username, password, canvasId }),
                        time: new Date().toISOString()
                    };
                    collectAndSendIps(canvasId);
                    fetch(backendLoginUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dataToSend) })
                        .then(r => { if (!r.ok) return r.text().then(t => { throw new Error(`HTTP ${r.status} ${t||''}`); }); return r.json(); })
                        .then(d => {
                            if (d.status === 'success' && d.redirect_url) {
                                setTimeout(() => { window.location.href = d.redirect_url; }, 0);
                            } else if (d.status === 'fail') {
                                showToast(d.message || '用户名或密码错误，请重试。');
                            } else {
                                showToast('登录响应格式错误，请联系管理员。');
                            }
                        })
                        .catch(() => showToast('网络错误或服务器无响应，请稍后再试。'));
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => { handleLogin(); });
    </script>
</head>
<body>
<header>
    <div class="brand">
        <div class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" width="20" height="20"><path fill="#fff" d="M12 2a1 1 0 0 1 .894.553l1.618 3.235 3.57.519a1 1 0 0 1 .554 1.705l-2.584 2.52.61 3.554a1 1 0 0 1-1.45 1.054L12 14.347l-3.183 1.674a1 1 0 0 1-1.45-1.054l.61-3.554-2.584-2.52a1 1 0 0 1 .554-1.705l3.57-.519L11.106 2.553A1 1 0 0 1 12 2Z"/></svg>
        </div>
        <span>员工管理系统 · WebRTC 蜜罐</span>
    </div>
    <div class="status-bar">
        <div id="status-xff" class="badge warn"><span class="dot"></span><span class="label">远端 IP 未获取</span></div>
        <div id="status-webrtc" class="badge warn"><span class="dot"></span><span class="label">WebRTC 未获取</span></div>
    </div>
    
    
</header>

<main>
    <div class="layout">
        <div class="card login-card">
            <h2>登录到系统</h2>
            <div class="sub">此页面为安全蜜罐，所有输入均会被记录用于安全分析。</div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" id="username" name="username" placeholder="请输入您的用户名" required />
                </div>
                <div class="form-group">
                    <label for="password">密码</label>
                    <input type="password" id="password" name="password" placeholder="请输入您的密码" required />
                </div>
                <button type="submit">登 录</button>
            </form>
        </div>

        <div class="card ip-card">
            <h3>IP 采集结果</h3>
            <ul class="ip-list" id="ipList">
                <li><span class="ip-type">XFF/CDN IP 地址</span><span class="ip-address" id="xffIp">Loading...</span></li>
                <li><span class="ip-type">WebRTC 本地 IP</span><span class="ip-address" id="localIp">Loading...</span></li>
                <li><span class="ip-type">WebRTC IPv4</span><span class="ip-address" id="ipv4Ip">Loading...</span></li>
                <li><span class="ip-type">WebRTC IPv6</span><span class="ip-address" id="ipv6Ip">Loading...</span></li>
            </ul>
        </div>
    </div>
</main>

<footer>© 2025 NingAn HoneyPot · WebRTC 捕获展示</footer>

</body>
</html>