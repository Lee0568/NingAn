<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>命令终端</title>
    <style>
        body {
            background-color: #1a1a1a;
            color: #00ff00; /* 绿色文字，模拟终端 */
            font-family: 'Courier New', Courier, monospace;
            padding: 20px;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* 防止页面滚动 */
        }
        #output {
            flex-grow: 1; /* 占据可用空间 */
            overflow-y: auto; /* 允许滚动 */
            white-space: pre-wrap; /* 保留空白和换行 */
            word-wrap: break-word; /* 自动换行 */
            border-bottom: 1px solid #00ff00;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        #input-container {
            display: flex;
            align-items: center;
        }
        #prompt {
            color: #00ff00;
            margin-right: 5px;
        }
        #command-input {
            background-color: transparent;
            border: none;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1em;
            outline: none; /* 移除选中时的边框 */
            flex-grow: 1; /* 占据剩余空间 */
            caret-color: transparent; /* 隐藏原生光标 */
        }

        /* 模拟光标 */
        #cursor {
            background-color: #00ff00;
            width: 8px; /* 光标宽度 */
            height: 1em; /* 光标高度与文字高度一致 */
            display: inline-block;
            vertical-align: text-bottom; /* 与文字底部对齐 */
            animation: blink-caret 1s infinite;
            margin-left: 2px; /* 与文字间隔 */
        }

        @keyframes blink-caret {
            from, to { opacity: 0; }
            50% { opacity: 1; }
        }

        /* 隐藏输入框，我们用模拟光标 */
        #command-input:focus + #cursor {
            animation: none; /* 聚焦时停止闪烁 */
            opacity: 1; /* 聚焦时显示光标 */
        }
    </style>
</head>
<body>

<div id="output">
        <pre>
Loki Honeypot v1.0
Type 'help' for available commands.
        </pre>
</div>

<div id="input-container">
    <span id="prompt">lokiuser@honeypot:~$&nbsp;</span>
    <input type="text" id="command-input" autofocus>
    <span id="cursor"></span> </div>

<script>
    const commandInput = document.getElementById('command-input');
    const outputDiv = document.getElementById('output');
    const cursor = document.getElementById('cursor'); // 获取光标元素
    const promptSpan = document.getElementById('prompt'); // 获取提示符元素

    const API_URL = 'http://127.0.0.1:65535/api/v2/execute'; // 命令执行后端接口
    const LOG_API_URL = 'http://127.0.0.1:65535/api/httplog/userInfo'; // 日志记录后端接口

    // ** 这是复用的 Canvas 指纹识别函数 **
    async function getCanvasFingerprint() {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            const text = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ`~1!2@3#4$5%6^7&8*9(0)-_=+[{]}\\|;:\'",<.>/?';
            ctx.textBaseline = 'top';
            ctx.font = '14px "Arial"';
            ctx.textBaseline = 'alphabetic';
            ctx.fillStyle = '#f60';
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = '#069';
            ctx.fillText(text, 2, 15);
            ctx.fillStyle = 'rgba(102, 204, 0, 0.2)';
            ctx.fillText(text, 4, 17);

            const dataUrl = canvas.toDataURL();
            const encoder = new TextEncoder();
            const data = encoder.encode(dataUrl);

            window.crypto.subtle.digest('SHA-256', data).then(hashBuffer => {
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                resolve(hashHex);
            }).catch(error => {
                console.error('Canvas 指纹哈希计算失败:', error);
                resolve(null);
            });
        });
    }

    // 模拟滚动到底部
    function scrollToBottom() {
        outputDiv.scrollTop = outputDiv.scrollHeight;
    }

    // 更新光标位置
    function updateCursorPosition() {
        const inputWidth = commandInput.scrollWidth; // 输入文本的实际宽度
        cursor.style.left = `${promptSpan.offsetWidth + inputWidth + 5}px`; // 根据提示符和输入文本的宽度调整光标位置
    }

    // 初始显示内容后滚动
    scrollToBottom();
    // 初始设置光标位置
    updateCursorPosition();

    commandInput.addEventListener('input', updateCursorPosition); // 监听输入事件来更新光标位置

    commandInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // 阻止默认的回车行为（如表单提交）
            const command = commandInput.value.trim();
            commandInput.value = ''; // 清空输入框

            // 将用户输入的命令添加到输出区域
            outputDiv.innerHTML += `<pre><span id="prompt">lokiuser@honeypot:~$</span> ${command}</pre>`;
            scrollToBottom();
            updateCursorPosition(); // 清空后重新调整光标位置

            if (command === 'clear') { // 特殊处理 'clear' 命令
                outputDiv.innerHTML = `<pre>
Loki Honeypot v1.0
Type 'help' for available commands.
</pre>`;
                scrollToBottom();
                updateCursorPosition();
                return;
            } else if (command === 'help') { // 简单的 help 命令模拟
                outputDiv.innerHTML += `<pre>Available commands:
  help      - Show this help message
  clear     - Clear the screen
  echo [text] - Echo the provided text
  (any other command will be sent to the backend)
</pre>`;
                scrollToBottom();
                updateCursorPosition();
                return;
            } else if (command.startsWith('echo ')) { // 模拟 echo 命令
                const echoText = command.substring(5);
                outputDiv.innerHTML += `<pre>${echoText}</pre>`;
                scrollToBottom();
                updateCursorPosition();
                return;
            }


            if (command) {
                // ** 新增：先获取 canvas 指纹，再发送日志 **
                getCanvasFingerprint().then(fingerprint => {
                    const currentDateTime = new Date().toISOString(); // 获取当前ISO格式时间
                    const userAgent = navigator.userAgent; // 获取浏览器User-Agent
                    const clientIp = '127.0.0.1'; // 前端无法直接获取真实客户端IP，这里用循环地址模拟

                    const logPayload = {
                        canvasId: fingerprint, // ** 新增字段 **
                        method: 'POST', // 模拟为POST请求
                        path: '/api/v2/execute', // 模拟被攻击的路径
                        parameter: '', // 模拟没有URL参数
                        // 嵌套的body字段，包含 command
                        body: JSON.stringify({
                            command: command,
                            canvasId: fingerprint // ** body 中也包含指纹 **
                        }),
                        headers: JSON.stringify({
                            'User-Agent': userAgent,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }),
                        time: currentDateTime
                    };

                    fetch(LOG_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(logPayload) // 发送构建好的日志载荷
                    })
                        .then(logResponse => {
                            if (!logResponse.ok) {
                                console.warn(`Warning: Failed to log command. Status: ${logResponse.status}`);
                            }
                        })
                        .catch(logError => {
                            console.error('Error sending log:', logError);
                        });
                });
                // ** 日志发送逻辑结束 **


                // 发送POST请求到蜜罐命令执行后端
                fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json' // 告诉服务器我们期望JSON响应
                    },
                    body: JSON.stringify({ command: command }) // 将命令封装为JSON对象
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const responseContent = data && data.command ? data.command : "Error: No command result received or malformed response.";
                        outputDiv.innerHTML += `<pre>${responseContent}</pre>`;
                        scrollToBottom();
                        updateCursorPosition();
                    })
                    .catch(error => {
                        outputDiv.innerHTML += `<pre style="color: red;">Error: Could not connect to honeypot backend or an error occurred: ${error.message}</pre>`;
                        console.error('Fetch error:', error);
                        scrollToBottom();
                        updateCursorPosition();
                    });
            }
        }
    });

    // 页面加载完成后，自动聚焦输入框
    window.addEventListener('load', () => {
        commandInput.focus();
        updateCursorPosition();
    });

    // 点击页面任何地方都重新聚焦输入框并更新光标位置
    document.addEventListener('click', () => {
        commandInput.focus();
        updateCursorPosition();
    });
</script>
</body>
</html>