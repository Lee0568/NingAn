<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>防御策略设置</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #1a253c;
            border-bottom: 2px solid #eef2f5;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .policy-section {
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .form-group label {
            flex: 1;
            font-weight: 600;
            margin-right: 15px;
        }
        .form-group input[type="number"],
        .form-group input[type="text"] {
            flex: 2;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        .form-group .unit {
            margin-left: 10px;
            color: #666;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .ip-list-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        #search-ip {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 250px;
        }
        .ip-list-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .ip-list-table th, .ip-list-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .ip-list-table th {
            background-color: #f8f9fa;
            font-weight: 700;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
            width: 100%;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .pagination {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .pagination button {
            margin: 0 5px;
            padding: 8px 16px;
            border: 1px solid #ddd;
            background-color: #fff;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button:hover {
            background-color: #f0f0f0;
        }
        .pagination button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
            z-index: 1000;
        }
        .toast.show {
            opacity: 1;
            visibility: visible;
        }
        .refresh-btn {
            background-color: #28a745;
            color: white;
            margin-left: 10px;
        }
        .refresh-btn:hover {
            background-color: #218838;
        }
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        #pagination-buttons-wrapper {
            display: flex;
            align-items: center;
        }
        /* 新增页码跳转相关样式 */
        .jump-to-page {
            display: flex;
            align-items: center;
            margin-left: 15px;
        }
        .jump-to-page input {
            width: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 0 5px;
            text-align: center;
        }
        .jump-to-page button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background-color: #fff;
            cursor: pointer;
            border-radius: 4px;
        }
        .jump-to-page button:hover {
            background-color: #f0f0f0;
        }
        .page-info {
            margin: 0 10px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-controls">
        <h1>安全防御策略</h1>
        <button class="btn refresh-btn" onclick="refreshAllSettings()">获取最新配置信息</button>
    </div>

    <div class="policy-section">
        <h2>1. 自动封禁IP策略</h2>
        <div class="form-group">
            <label for="attack-freq-ban">当IP在1分钟内攻击频率达到</label>
            <input type="number" id="attack-freq-ban" placeholder="点击'获取最新配置信息'获取" value="">
            <span class="unit">次时，自动封禁该IP</span>
        </div>
        <div class="form-group">
            <label for="ban-duration">自动封禁持续时间</label>
            <input type="number" id="ban-duration" placeholder="点击'获取最新配置信息'获取" value="">
            <span class="unit">分钟</span>
        </div>
        <button class="btn btn-primary" onclick="saveAutoBanSettings()">保存封禁策略</button>
    </div>

    <div class="policy-section">
        <h2>2. 当前已封禁IP列表</h2>
        <div class="ip-list-controls">
            <input type="text" id="search-ip" placeholder="搜索IP、模式或到期时间...">
            <button class="btn refresh-btn" onclick="refreshBlockedIPs()">刷新列表</button>
        </div>
        <table class="ip-list-table" id="blocked-ip-table">
            <thead>
            <tr>
                <th>被封禁IP</th>
                <th>封禁模式</th>
                <th>到期时间</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <div class="pagination" id="pagination-controls">
            <div id="pagination-buttons-wrapper">
            </div>
        </div>
    </div>

    <div class="policy-section">
        <h2>3. 短信提醒设置</h2>
        <div class="form-group">
            <label for="sms-time-window" style="flex: 1.2;">当网站在</label>
            <input type="number" id="sms-time-window" placeholder="点击'获取最新配置信息'获取" style="flex: 0.5; text-align: center;">
            <label for="attack-freq-sms" style="flex: 1.5; margin-left: 10px;">分钟内被攻击总次数达到</label>
            <input type="number" id="attack-freq-sms" placeholder="点击'获取最新配置信息'获取" style="flex: 1;">
            <span class="unit">次后，发送短信提醒</span>
        </div>
        <div class="form-group">
            <label for="admin-phone">接收短信的管理员手机号</label>
            <input type="text" id="admin-phone" placeholder="点击'获取最新配置信息'获取">
            <span class="unit"></span>
        </div>
        <button class="btn btn-primary" onclick="saveSmsSettings()">保存短信设置</button>
    </div>
</div>

<div id="toast-message" class="toast"></div>

<script>
    let lastRefreshTime = 0;
    const MIN_REFRESH_INTERVAL = 1000;
    let allBlockedIps = [];
    let filteredIps = [];
    let currentPage = 1;
    const rowsPerPage = 5;

    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM fully loaded and parsed. Initializing page functions.");

        const searchInput = document.getElementById('search-ip');
        searchInput.addEventListener('input', filterAndRender);

        refreshAllSettings();
        loadBlockedIps();
    });

    function filterAndRender() {
        const searchInputEl = document.getElementById('search-ip');
        const query = searchInputEl ? searchInputEl.value.toLowerCase() : "";
        if (query) {
            filteredIps = allBlockedIps.filter(item =>
                item.ipAddress.toLowerCase().includes(query) ||
                item.blockMode.toLowerCase().includes(query) ||
                item.expiresAt.toLowerCase().includes(query)
            );
        } else {
            filteredIps = [...allBlockedIps];
        }
        currentPage = 1;
        renderTableAndPagination();
    }

    function displayList(items, wrapper, rows_per_page, page) {
        wrapper.innerHTML = "";
        page--;
        let start = rows_per_page * page;
        let end = start + rows_per_page;
        let paginatedItems = items.slice(start, end);
        paginatedItems.forEach(item => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${item.ipAddress}</td>
                <td>${item.blockMode}</td>
                <td>${item.expiresAt}</td>
                <td>
                    <button class="btn btn-danger" onclick="unbanIp('${item.ipAddress}')">
                        解封
                    </button>
                </td>
            `;
            wrapper.appendChild(row);
        });
    }

    function setupPagination(items, wrapper, rows_per_page) {
        wrapper.innerHTML = "";
        const page_count = Math.ceil(items.length / rows_per_page);

        if (page_count <= 1) {
            return;
        }

        // 添加上一页按钮
        const prevButton = document.createElement('button');
        prevButton.innerHTML = '&laquo;';
        prevButton.disabled = currentPage === 1;
        prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTableAndPagination();
            }
        });
        wrapper.appendChild(prevButton);

        // 添加页码按钮
        const page_window = 2;
        const createEllipsis = () => {
            const ellipsis = document.createElement('span');
            ellipsis.innerText = '...';
            ellipsis.style.padding = '8px 12px';
            ellipsis.style.margin = '0 5px';
            return ellipsis;
        };

        let buttons = [];
        buttons.push(createPaginationButton(1, items));

        if (currentPage > page_window + 2) {
            buttons.push(createEllipsis());
        }

        for (let i = Math.max(2, currentPage - page_window); i <= Math.min(page_count - 1, currentPage + page_window); i++) {
            buttons.push(createPaginationButton(i, items));
        }

        if (currentPage < page_count - (page_window + 1)) {
            buttons.push(createEllipsis());
        }

        if (page_count > 1) {
            buttons.push(createPaginationButton(page_count, items));
        }

        buttons.forEach(btn => wrapper.appendChild(btn));

        // 添加下一页按钮
        const nextButton = document.createElement('button');
        nextButton.innerHTML = '&raquo;';
        nextButton.disabled = currentPage === page_count;
        nextButton.addEventListener('click', () => {
            if (currentPage < page_count) {
                currentPage++;
                renderTableAndPagination();
            }
        });
        wrapper.appendChild(nextButton);

        // 添加页码信息和跳转功能
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `第 ${currentPage} 页，共 ${page_count} 页`;
        wrapper.appendChild(pageInfo);

        const jumpContainer = document.createElement('div');
        jumpContainer.className = 'jump-to-page';

        const jumpInput = document.createElement('input');
        jumpInput.type = 'number';
        jumpInput.min = 1;
        jumpInput.max = page_count;
        jumpInput.placeholder = '页码';

        const jumpButton = document.createElement('button');
        jumpButton.textContent = '跳转';
        jumpButton.addEventListener('click', jumpToPage);

        jumpInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                jumpToPage();
            }
        });

        jumpContainer.appendChild(document.createTextNode('跳转到'));
        jumpContainer.appendChild(jumpInput);
        jumpContainer.appendChild(jumpButton);
        wrapper.appendChild(jumpContainer);
    }

    function createPaginationButton(page, items) {
        let button = document.createElement('button');
        button.innerText = page;
        if (currentPage == page) button.classList.add('active');
        button.addEventListener('click', function () {
            currentPage = page;
            renderTableAndPagination();
        });
        return button;
    }

    function renderTableAndPagination() {
        const tableBody = document.querySelector("#blocked-ip-table tbody");
        const buttonsWrapper = document.getElementById('pagination-buttons-wrapper');
        if (tableBody && buttonsWrapper) {
            displayList(filteredIps, tableBody, rowsPerPage, currentPage);
            setupPagination(filteredIps, buttonsWrapper, rowsPerPage);
        } else {
            console.error("关键渲染元素 'tableBody' 或 'pagination-buttons-wrapper' 未找到!");
        }
    }

    function jumpToPage() {
        const jumpInput = document.querySelector('.jump-to-page input');
        if (!jumpInput) return;

        const pageCount = Math.ceil(filteredIps.length / rowsPerPage);
        let targetPage = parseInt(jumpInput.value);

        if (isNaN(targetPage) || targetPage < 1 || targetPage > pageCount) {
            showToast(`请输入有效的页码 (1-${pageCount})`);
            jumpInput.value = '';
            return;
        }

        currentPage = targetPage;
        renderTableAndPagination();
        jumpInput.value = '';
    }

    async function loadBlockedIps() {
        console.log("Fetching blocked IP list...");
        try {
            const response = await fetch('/api/policy/blocked-ips', { credentials: 'same-origin' });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const rawText = await response.text();
            allBlockedIps = JSON.parse(rawText);
            filterAndRender();
        } catch (error) {
            console.error("Failed to load or parse blocked IPs:", error);
            showToast("加载封禁IP列表失败。");
            allBlockedIps = [];
            filterAndRender();
        }
    }

    async function refreshBlockedIPs() {
        if (!canRefresh()) return;
        await loadBlockedIps();
        showToast("已刷新封禁IP列表。");
    }

    async function unbanIp(ip) {
        if (!confirm(`您确定要解封IP地址 ${ip} 吗？`)) return;
        try {
            const response = await fetch(`/api/policy/blocked-ips/${ip}`, {
                method: 'DELETE',
                credentials: 'same-origin'
            });
            const responseText = await response.text();
            showToast(responseText);
            if (response.ok) {
                await loadBlockedIps();
            }
        } catch (error) {
            console.error("Failed to unban IP:", error);
            showToast("解封失败。");
        }
    }

    function canRefresh() {
        const now = Date.now();
        if (now - lastRefreshTime < MIN_REFRESH_INTERVAL) {
            showToast("操作过于频繁，请稍后再试");
            return false;
        }
        lastRefreshTime = now;
        return true;
    }

    async function loadAutoBanSettings() {
        console.log("Attempting to fetch auto-ban settings...");
        try {
            const response = await fetch('http://127.0.0.1:65535/api/policy/autoban', {credentials:'same-origin'});
            if (response.ok) {
                const settings = await response.json();
                document.getElementById('attack-freq-ban').value = settings.frequency;
                document.getElementById('ban-duration').value = settings.duration;
                return true;
            } else {
                showToast("加载当前策略失败。");
                return false;
            }
        } catch (error) {
            showToast("加载当前策略失败。");
            return false;
        }
    }

    async function saveAutoBanSettings() {
        const freqInput = document.getElementById('attack-freq-ban');
        const durationInput = document.getElementById('ban-duration');
        if (!freqInput.value || !durationInput.value) {
            showToast('请先获取最新配置信息。');
            return;
        }
        const frequency = parseInt(freqInput.value, 10);
        const duration = parseInt(durationInput.value, 10);
        const settingsData = {
            frequency: frequency,
            duration: duration
        };
        try {
            const response = await fetch('http://127.0.0.1:65535/api/policy/autoban', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settingsData)
            });
            const responseText = await response.text();
            if (response.ok) {
                showToast(responseText);
                setTimeout(() => {
                    loadAutoBanSettings();
                }, 1000);
            } else {
                showToast(responseText || '保存失败。');
            }
        } catch (error) {
            showToast('保存失败。');
        }
    }

    async function saveSmsSettings() {
        const timeWindow = parseInt(document.getElementById('sms-time-window').value, 10);
        const attacks = parseInt(document.getElementById('attack-freq-sms').value, 10);
        const phone = document.getElementById('admin-phone').value;
        if (!timeWindow || !attacks || !phone.trim()) {
            showToast("所有短信设置项均为必填项。");
            return;
        }
        const settingsData = {
            timeWindowMinutes: timeWindow,
            attacksAmount: attacks,
            phone: phone
        };
        try {
            const response = await fetch('http://127.0.0.1:65535/api/policy/updateSmsSettings', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settingsData)
            });
            const responseText = await response.text();
            if (response.ok) {
                showToast(responseText);
            } else {
                showToast(responseText || '保存失败。');
            }
        } catch (error) {
            console.error("保存短信设置时出错:", error);
            showToast('保存失败。');
        }
    }

    async function loadSmsSettings() {
        console.log("Attempting to fetch SMS settings...");
        try {
            const response = await fetch('http://127.0.0.1:65535/api/policy/updateSmsSettings', {credentials:'same-origin'});
            if (response.ok) {
                const settings = await response.json();
                document.getElementById('sms-time-window').value = settings.timeWindowMinutes;
                document.getElementById('attack-freq-sms').value = settings.attacksAmount;
                document.getElementById('admin-phone').value = settings.phone;
                return true;
            } else {
                showToast("加载短信策略失败。");
                return false;
            }
        } catch (error) {
            showToast("加载短信策略失败。");
            return false;
        }
    }

    async function refreshAllSettings() {
        if (!canRefresh()) return;
        showToast("正在获取最新配置信息...");
        try {
            await Promise.all([loadAutoBanSettings(), loadSmsSettings()]);
            showToast("配置信息已全部更新。");
        } catch (error) {
            showToast("部分配置信息刷新失败。");
        }
    }

    function showToast(message) {
        const toast = document.getElementById('toast-message');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === 'F5') { return; }
        if (event.ctrlKey && (event.key === 'r' || event.key === 'R')) {
            event.preventDefault();
            refreshAllSettings();
            refreshBlockedIPs();
        }
    });
</script>
</body>
</html>