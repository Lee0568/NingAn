<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Terminal</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/layui/css/layui.css" media="all">
    <style>
        .terminal-container {
            padding: 15px;
        }
        .terminal {
            background-color: #000;
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            outline: none;
            cursor: text;
            user-select: text;
        }
        .terminal-input {
            margin-top: 15px;
        }
        .connection-form {
            margin-bottom: 15px;
        }
        .prompt {
            color: #0f0;
        }
    </style>
</head>
<body>
<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main">
        <fieldset class="table-search-fieldset">
            <legend>终端控制</legend>
            <div style="margin: 10px 10px 10px 10px">
                <form class="layui-form layui-form-pane connection-form" action="">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">服务器:</label>
                            <div class="layui-input-inline">
                                <input type="text" name="host" id="host" autocomplete="off" class="layui-input" placeholder="输入服务器地址" value="localhost">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">端口:</label>
                            <div class="layui-input-inline">
                                <input type="text" name="port" id="port" autocomplete="off" class="layui-input" placeholder="端口" value="22">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">用户名:</label>
                            <div class="layui-input-inline">
                                <input type="text" name="username" id="username" autocomplete="off" class="layui-input" placeholder="用户名" value="root">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">密码:</label>
                            <div class="layui-input-inline">
                                <input type="password" name="password" id="password" autocomplete="off" class="layui-input" placeholder="密码">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <button type="button" class="layui-btn" id="connect-btn">连接</button>
                            <button type="button" class="layui-btn layui-btn-danger" id="disconnect-btn" style="display:none;">断开</button>
                        </div>
                    </div>
                </form>
            </div>
        </fieldset>

        <div class="terminal-container">
            <div class="terminal" id="terminal-output" tabindex="0"></div>
        </div>
    </div>
</div>

<script src="/layui/layui.js" charset="utf-8"></script>
<script>
    layui.use(['form', 'jquery'], function(){
        var $ = layui.jquery;

        // 初始化WebSocket连接
        window.terminalWebSocket = null;
        let currentPrompt = "root@loki:~# ";
        let commandBuffer = "";
        let isConnected = false;

        // 连接按钮事件
        $('#connect-btn').on('click', function(){
            const host = $('#host').val();
            const port = $('#port').val();
            const username = $('#username').val();
            const password = $('#password').val();

            if (!host || !port || !username) {
                layer.msg('请填写完整的连接信息');
                return;
            }

            // 创建连接信息对象
            const connectInfo = {
                host: host,
                port: parseInt(port),
                username: username,
                password: password
            };

            // 初始化WebSocket连接
            initWebSocket(connectInfo);
        });

        // 断开连接按钮事件
        $('#disconnect-btn').on('click', function(){
            if (window.terminalWebSocket) {
                window.terminalWebSocket.close();
            }
        });

        // 终端区域事件处理
        const $terminal = $('#terminal-output');
        
        // 点击终端区域时聚焦
        $terminal.on('click', function() {
            $(this).focus();
        });

        // 处理粘贴事件
        $terminal.on('paste', function(e) {
            e.preventDefault();
            if (!isConnected || !window.terminalWebSocket || window.terminalWebSocket.readyState !== WebSocket.OPEN) {
                return;
            }
            
            let paste = (e.clipboardData || window.clipboardData).getData('text');
            commandBuffer += paste;
            updateCurrentLine();
        });

        // 终端键盘事件
        $terminal.on('keydown', function(event) {
            // 如果终端未连接，则不处理任何按键
            if (!isConnected || !window.terminalWebSocket || window.terminalWebSocket.readyState !== WebSocket.OPEN) {
                // 允许F5刷新等系统快捷键
                if (!(event.key === 'F5' || (event.ctrlKey && event.key === 'r'))) {
                    event.preventDefault();
                }
                return;
            }

            // 处理回车键
            if (event.key === 'Enter') {
                event.preventDefault();
                
                // 显示命令和换行
                $terminal.append(commandBuffer + '\n');
                scrollToBottom();
                
                // 发送命令到后端
                window.terminalWebSocket.send(commandBuffer);
                
                // 清空命令缓冲区
                commandBuffer = "";
                return;
            }

            // 处理退格键
            if (event.key === 'Backspace') {
                event.preventDefault();
                if (commandBuffer.length > 0) {
                    // 删除最后一个字符
                    commandBuffer = commandBuffer.slice(0, -1);
                    updateCurrentLine();
                }
                return;
            }

            // 处理删除键
            if (event.key === 'Delete') {
                event.preventDefault();
                return;
            }

            // 处理左/右箭头键
            if (event.key === 'ArrowLeft' || event.key === 'ArrowRight' || 
                event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                event.preventDefault();
                return;
            }

            // 处理Tab键
            if (event.key === 'Tab') {
                event.preventDefault();
                commandBuffer += "    "; // 插入4个空格
                updateCurrentLine();
                return;
            }

            // 处理Home/End键
            if (event.key === 'Home' || event.key === 'End') {
                event.preventDefault();
                return;
            }

            // 处理字符输入（只处理可见字符）
            if (event.key.length === 1 && !event.ctrlKey && !event.altKey) {
                event.preventDefault();
                commandBuffer += event.key;
                updateCurrentLine();
                return;
            }

            // 阻止其他控制键的默认行为
            if (!(event.key === 'F5' || (event.ctrlKey && event.key === 'r'))) {
                event.preventDefault();
            }
        });

        function initWebSocket(connectInfo) {
            if (window.terminalWebSocket) {
                window.terminalWebSocket.close();
            }

            const ws = new WebSocket('ws://' + window.location.host + '/ssh-terminal');
            window.terminalWebSocket = ws;

            ws.onopen = function(event) {
                $terminal.empty(); // 清空终端
                $terminal.append('正在连接到 ' + connectInfo.host + '...\n');
                scrollToBottom();

                // 发送连接信息到后端
                ws.send(JSON.stringify(connectInfo));

                $('#connect-btn').hide();
                $('#disconnect-btn').show();
                isConnected = true;
                
                // 聚焦到终端区域
                $terminal.focus();
                
                // 显示初始提示符
                appendPrompt();
            };

            ws.onmessage = function(event) {
                $terminal.append(event.data);
                scrollToBottom();
                
                // 如果收到的是换行结尾的内容，添加新提示符
                if (event.data.endsWith('\n')) {
                    appendPrompt();
                }
            };

            ws.onclose = function(event) {
                $terminal.append('\n连接已断开。\n');
                scrollToBottom();
                $('#connect-btn').show();
                $('#disconnect-btn').hide();
                isConnected = false;
                window.terminalWebSocket = null;
            };

            ws.onerror = function(error) {
                $terminal.append('WebSocket错误: ' + error + '\n');
                scrollToBottom();
            };
        }

        // 更新当前行显示
        function updateCurrentLine() {
            const content = $terminal.text();
            const lines = content.split('\n');
            
            // 如果没有任何行，直接显示提示符
            if (lines.length === 0) {
                $terminal.text(currentPrompt + commandBuffer);
                scrollToBottom();
                return;
            }
            
            // 更新最后一行（当前行）
            lines[lines.length - 1] = currentPrompt + commandBuffer;
            $terminal.text(lines.join('\n'));
            scrollToBottom();
        }

        // 添加提示符
        function appendPrompt() {
            $terminal.append(currentPrompt);
            commandBuffer = "";
            scrollToBottom();
        }

        // 滚动到底部
        function scrollToBottom() {
            $terminal.scrollTop($terminal[0].scrollHeight);
        }
    });
</script>
</body>
</html>