<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>文件管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/layui/css/layui.css" media="all">
    <style>
        .file-container {
            padding: 15px;
            display: flex;
            flex-direction: row;
            height: 600px;
        }
        .file-browser {
            background-color: #fff;
            border: 1px solid #e6e6e6;
            border-radius: 4px;
            padding: 15px;
            flex-grow: 1;
            margin-right: 10px;
            overflow-y: auto;
        }
        .server-panel {
            width: 25%;
            background-color: #f5f5f5;
            border-radius: 4px;
            padding: 15px;
            overflow-y: auto;
        }
        .server-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        .server-item {
            padding: 8px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            background-color: #fff;
            cursor: pointer;
        }
        .server-item:hover {
            background-color: #e6e6e6;
        }
        .server-item.active {
            background-color: #009688;
            color: #fff;
        }
        .connection-form {
            margin-bottom: 15px;
        }
        .file-list {
            margin-top: 10px;
        }
        .file-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .file-item .file-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .file-item:hover .file-actions {
            opacity: 1;
        }
        .file-item:hover {
            background-color: #f5f5f5;
        }
        .file-icon {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }
        .file-name {
            flex-grow: 1;
        }
        .file-size {
            color: #999;
            font-size: 12px;
            margin-left: 10px;
        }
        .file-time {
            color: #999;
            font-size: 12px;
            margin-left: 10px;
        }
        .breadcrumb {
            padding: 10px 0;
            border-bottom: 1px solid #e6e6e6;
            margin-bottom: 10px;
        }
        .breadcrumb a {
            color: #009688;
            text-decoration: none;
            margin-right: 5px;
        }
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        .file-operations {
            margin-bottom: 10px;
        }
        .connection-status {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            text-align: center;
        }
        .connection-status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .connection-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main">
        <fieldset class="table-search-fieldset">
            <legend>文件管理</legend>
            <div style="margin: 10px 10px 10px 10px">
                <div class="file-container">
                    <div class="file-browser">
                        <!-- 连接状态显示 -->
                        <div class="connection-status disconnected" id="connection-status">
                            未连接到服务器
                        </div>
                        
                        <!-- 文件操作按钮 -->
                        <div class="file-operations" id="file-operations" style="display: none;">
                            <button type="button" class="layui-btn layui-btn-sm" id="refresh-btn">
                                <i class="layui-icon layui-icon-refresh"></i> 刷新
                            </button>
                            <button type="button" class="layui-btn layui-btn-sm layui-btn-normal" id="upload-btn">
                                <i class="layui-icon layui-icon-upload"></i> 上传
                            </button>
                            <button type="button" class="layui-btn layui-btn-sm layui-btn-warm" id="mkdir-btn">
                                <i class="layui-icon layui-icon-add-1"></i> 新建文件夹
                            </button>
                            <button type="button" class="layui-btn layui-btn-sm layui-btn-danger" id="disconnect-file-btn">
                                <i class="layui-icon layui-icon-close"></i> 断开连接
                            </button>
                        </div>
                        
                        <!-- 路径导航 -->
                        <div class="breadcrumb" id="breadcrumb" style="display: none;">
                            <span>当前路径：</span>
                            <a href="#" data-path="/">根目录</a>
                        </div>
                        
                        <!-- 文件列表 -->
                        <div class="file-list" id="file-list">
                            <div style="text-align: center; color: #999; padding: 50px 0;">
                                请先连接到服务器
                            </div>
                        </div>
                    </div>
                    
                    <div class="server-panel">
                        <h3>服务器管理</h3>
                        <!-- 添加切换按钮 -->
                        <div class="layui-btn-container" style="margin-bottom: 15px;">
                            <button type="button" class="layui-btn layui-btn-primary" id="show-add-form">添加服务器</button>
                            <button type="button" class="layui-btn layui-btn-primary" id="show-server-list">服务器列表</button>
                        </div>
                        
                        <!-- 添加服务器表单 -->
                        <div id="add-server-panel">
                            <form class="layui-form layui-form-pane connection-form" action="">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">服务器:</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="host" id="host" autocomplete="off" class="layui-input" placeholder="输入服务器地址" value="localhost">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">端口:</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="port" id="port" autocomplete="off" class="layui-input" placeholder="端口" value="22">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">用户名:</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="username" id="username" autocomplete="off" class="layui-input" placeholder="用户名" value="root">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">密码:</label>
                                    <div class="layui-input-block">
                                        <input type="password" name="password" id="password" autocomplete="off" class="layui-input" placeholder="密码">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">备注:</label>
                                    <div class="layui-input-block">
                                        <input type="text" name="remark" id="remark" autocomplete="off" class="layui-input" placeholder="服务器备注">
                                    </div>
                                </div>
                                <div class="layui-form-item">
                                    <div class="layui-input-block">
                                        <button type="button" class="layui-btn" id="connect-btn" lay-submit lay-filter="connect">连接</button>
                                        <button type="button" class="layui-btn layui-btn-normal" id="save-server-btn" lay-submit lay-filter="save-server">保存</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- 服务器列表 -->
                        <div id="server-list-panel" style="display: none;">
                            <div class="server-list" id="server-list">
                                <!-- 服务器列表将通过JavaScript动态填充 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>
    </div>
</div>

<script src="/layui/layui.js" charset="utf-8"></script>
<script>
    layui.use(['form', 'jquery', 'layer', 'upload'], function(){
        var $ = layui.jquery;
        var form = layui.form;
        var layer = layui.layer;
        var upload = layui.upload;

        // 全局变量
        let isConnected = false;
        let currentServer = null;
        let currentPath = '/';
        let servers = [];
        let currentPanel = 'add';

        // 切换到添加服务器面板
        function showAddServerPanel() {
            $('#add-server-panel').show();
            $('#server-list-panel').hide();
            $('#show-add-form').addClass('layui-btn-primary');
            $('#show-server-list').removeClass('layui-btn-primary');
            currentPanel = 'add';
        }

        // 切换到服务器列表面板
        function showServerListPanel() {
            $('#add-server-panel').hide();
            $('#server-list-panel').show();
            $('#show-add-form').removeClass('layui-btn-primary');
            $('#show-server-list').addClass('layui-btn-primary');
            currentPanel = 'list';
            loadServers();
        }

        // 绑定切换按钮事件
        $('#show-add-form').on('click', function() {
            showAddServerPanel();
        });

        $('#show-server-list').on('click', function() {
            showServerListPanel();
        });

        // 从后端加载服务器列表
        function loadServers() {
            $.get('/api/ssh/servers', function(res) {
                if (res.code === 200) {
                    servers = res.data;
                    renderServerList();
                } else {
                    layer.msg('加载服务器列表失败: ' + res.message);
                }
            }).fail(function() {
                layer.msg('加载服务器列表失败，请检查网络连接');
            });
        }

        // 渲染服务器列表
        function renderServerList() {
            const $serverList = $('#server-list');
            $serverList.empty();
            
            if (servers.length === 0) {
                $serverList.html('<p style="text-align: center; color: #999;">暂无服务器信息</p>');
                return;
            }
            
            servers.forEach((server, index) => {
                const isActive = currentServer && currentServer.id === server.id;
                const serverItem = $(`
                    <div class="server-item ${isActive ? 'active' : ''}" data-id="${server.id}" data-index="${index}">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div><strong>${server.remark || server.host}</strong></div>
                                <div>${server.host}:${server.port}</div>
                                <div>用户: ${server.username}</div>
                            </div>
                            <div>
                                <button class="layui-btn layui-btn-xs connect-server" data-index="${index}">连接</button>
                                <button class="layui-btn layui-btn-danger layui-btn-xs delete-server" data-id="${server.id}">删除</button>
                            </div>
                        </div>
                    </div>
                `);
                $serverList.append(serverItem);
            });
            
            // 绑定点击事件
            $('.server-item').on('click', function() {
                const index = $(this).data('index');
                const server = servers[index];
                showAddServerPanel();
                $('#host').val(server.host);
                $('#port').val(server.port);
                $('#username').val(server.username);
                $('#remark').val(server.remark || '');
            });
            
            // 绑定连接事件
            $('.connect-server').on('click', function(event) {
                event.stopPropagation();
                const index = $(this).data('index');
                const server = servers[index];
                connectToServer(server);
            });
            
            // 绑定删除事件
            $('.delete-server').on('click', function(event) {
                event.stopPropagation();
                
                const serverId = $(this).data('id');
                const serverItem = servers.find(s => s.id === serverId);
                
                layer.confirm('确定要删除服务器 "' + (serverItem.remark || serverItem.host) + '" 吗？', {
                    btn: ['确定','取消']
                }, function(index){
                    layer.close(index);
                    
                    $.ajax({
                        url: '/api/ssh/server/' + serverId,
                        type: 'DELETE',
                        success: function(res) {
                            if (res.code === 200) {
                                layer.msg('删除成功');
                                loadServers();
                            } else {
                                layer.msg('删除失败: ' + res.message);
                            }
                        },
                        error: function() {
                            layer.msg('删除失败，请检查网络连接');
                        }
                    });
                });
            });
        }

        // 保存服务器表单提交事件
        form.on('submit(save-server)', function(data){
            var host = $('#host').val();
            var port = $('#port').val();
            var username = $('#username').val();
            var password = $('#password').val();
            var remark = $('#remark').val();
            
            if(!host || !port || !username || !password){
                layer.msg('请填写完整的服务器信息');
                return false;
            }
            
            var server = {
                host: host,
                port: parseInt(port),
                username: username,
                password: password,
                remark: remark
            };
            
            // 发送到后端保存
            $.ajax({
                url: '/api/ssh/server',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(server),
                success: function(res) {
                    if (res.code === 200) {
                        layer.msg('服务器保存成功');
                        loadServers();
                        
                        // 清空表单
                        $('#host').val('');
                        $('#port').val('22');
                        $('#username').val('');
                        $('#password').val('');
                        $('#remark').val('');
                    } else {
                        layer.msg('保存失败: ' + res.message);
                    }
                },
                error: function() {
                    layer.msg('保存失败，请检查网络连接');
                }
            });
            
            return false;
        });

        // 连接服务器表单提交事件
        form.on('submit(connect)', function(data){
            var host = $('#host').val();
            var port = $('#port').val();
            var username = $('#username').val();
            var password = $('#password').val();
            
            if(!host || !port || !username || !password){
                layer.msg('请填写完整的连接信息');
                return false;
            }
            
            var server = {
                host: host,
                port: parseInt(port),
                username: username,
                password: password
            };
            
            connectToServer(server);
            return false;
        });

        // 连接到服务器
        function connectToServer(server) {
            currentServer = server;
            currentPath = '/';
            
            // 显示连接中状态
            const loadingIndex = layer.load(1, {
                shade: [0.1,'#fff']
            });
            
            // 测试连接
            $.ajax({
                url: '/api/ssh/connect',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(server),
                success: function(res) {
                    layer.close(loadingIndex);
                    if (res.success) {
                        isConnected = true;
                        updateConnectionStatus(true, server);
                        loadFileList(currentPath);
                        updateFileOperationButtons();
                        layer.msg('连接成功', {icon: 1});
                    } else {
                        layer.msg('连接失败: ' + (res.message || '未知错误'), {icon: 2});
                    }
                },
                error: function(xhr, status, error) {
                    layer.close(loadingIndex);
                    let errorMsg = '连接失败';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg += ': ' + xhr.responseJSON.message;
                    } else if (xhr.status === 0) {
                        errorMsg += ': 网络连接失败';
                    } else {
                        errorMsg += ': ' + error;
                    }
                    layer.msg(errorMsg, {icon: 2});
                }
            });
        }
        
        // 更新连接状态显示
        function updateConnectionStatus(connected, server) {
            const $status = $('#connection-status');
            if (connected && server) {
                $status.text(`已连接: ${server.remark || server.host}:${server.port}`)
                       .removeClass('disconnected')
                       .addClass('connected');
                $('#file-operations').show();
                $('#breadcrumb').show();
            } else {
                $status.text('未连接到服务器')
                       .removeClass('connected')
                       .addClass('disconnected');
                $('#file-operations').hide();
                $('#breadcrumb').hide();
            }
        }
        
        // 更新文件操作按钮状态
        function updateFileOperationButtons() {
            const buttons = ['#refresh-btn', '#upload-btn', '#mkdir-btn'];
            buttons.forEach(btn => {
                if (isConnected) {
                    $(btn).removeClass('layui-btn-disabled');
                } else {
                    $(btn).addClass('layui-btn-disabled');
                }
            });
        }
        
        // 加载文件列表
        function loadFileList(path) {
            if (!isConnected || !currentServer) {
                return;
            }
            
            // 显示加载状态
            $('#file-list').html('<div style="text-align: center; color: #999; padding: 20px 0;"><i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 加载中...</div>');
            
            $.ajax({
                url: '/api/ssh/files',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    host: currentServer.host,
                    port: currentServer.port,
                    username: currentServer.username,
                    password: currentServer.password,
                    path: path
                }),
                success: function(res) {
                    if (res.success) {
                        renderFileList(res.data);
                        updateBreadcrumb(path);
                        currentPath = path;
                    } else {
                        $('#file-list').html('<div style="text-align: center; color: #ff5722; padding: 20px 0;">加载失败: ' + (res.message || '未知错误') + '</div>');
                        layer.msg('加载文件列表失败: ' + (res.message || '未知错误'), {icon: 2});
                    }
                },
                error: function(xhr, status, error) {
                    let errorMsg = '加载文件列表失败';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg += ': ' + xhr.responseJSON.message;
                    } else if (xhr.status === 0) {
                        errorMsg += ': 网络连接失败';
                    } else {
                        errorMsg += ': ' + error;
                    }
                    $('#file-list').html('<div style="text-align: center; color: #ff5722; padding: 20px 0;">' + errorMsg + '</div>');
                    layer.msg(errorMsg, {icon: 2});
                }
            });
        }
        
        // 渲染文件列表
        function renderFileList(files) {
            const $fileList = $('#file-list');
            $fileList.empty();
            
            if (files.length === 0) {
                $fileList.html('<div style="text-align: center; color: #999; padding: 20px 0;">此目录为空</div>');
                return;
            }
            
            files.forEach(file => {
                const isDir = file.type === 'directory';
                const icon = isDir ? 'layui-icon-folder' : 'layui-icon-file';
                const size = isDir ? '-' : formatFileSize(file.size);
                
                const fileItem = $(`
                    <div class="file-item" data-path="${file.path}" data-type="${file.type}" data-name="${file.name}">
                        <div class="file-icon">
                            <i class="layui-icon ${icon}"></i>
                        </div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${size}</div>
                        <div class="file-time">${file.modifyTime}</div>
                        <div class="file-actions" style="margin-left: auto;">
                            <button class="layui-btn layui-btn-xs layui-btn-danger delete-file-btn" title="删除"><i class="layui-icon layui-icon-delete"></i></button>
                            <button class="layui-btn layui-btn-xs layui-btn-normal rename-file-btn" title="重命名"><i class="layui-icon layui-icon-edit"></i></button>
                            ${file.type === 'file' ? '<button class="layui-btn layui-btn-xs download-file-btn" title="下载"><i class="layui-icon layui-icon-download-circle"></i></button>' : ''}
                            ${file.type === 'file' ? '<button class="layui-btn layui-btn-xs layui-btn-warm view-file-btn" title="查看"><i class="layui-icon layui-icon-file"></i></button>' : ''}
                        </div>
                    </div>
                `);
                
                $fileList.append(fileItem);
            });
            
            // 绑定文件项点击事件
            $('.file-item').on('click', function(e) {
                // 如果点击的是操作按钮，不触发文件夹进入事件
                if ($(e.target).closest('.file-actions').length > 0) {
                    return;
                }
                
                const path = $(this).data('path');
                const type = $(this).data('type');
                
                if (type === 'directory') {
                    loadFileList(path);
                } else {
                    // 处理文件点击（可以添加下载或预览功能）
                    layer.msg('文件: ' + path);
                }
            });
            
            // 绑定删除按钮事件
            $('.delete-file-btn').on('click', function(e) {
                e.stopPropagation();
                const $fileItem = $(this).closest('.file-item');
                const fileName = $fileItem.data('name');
                const fileType = $fileItem.data('type');
                deleteFile(fileName, fileType);
            });
            
            // 绑定重命名按钮事件
            $('.rename-file-btn').on('click', function(e) {
                e.stopPropagation();
                const $fileItem = $(this).closest('.file-item');
                const fileName = $fileItem.data('name');
                renameFile(fileName);
            });
            
            // 绑定下载按钮事件
            $('.download-file-btn').on('click', function(e) {
                e.stopPropagation();
                const $fileItem = $(this).closest('.file-item');
                const fileName = $fileItem.data('name');
                downloadFile(fileName);
            });
            
            // 绑定查看按钮事件
            $('.view-file-btn').on('click', function(e) {
                e.stopPropagation();
                const $fileItem = $(this).closest('.file-item');
                const fileName = $fileItem.data('name');
                viewFile(fileName);
            });
        }
        
        // 更新面包屑导航
        function updateBreadcrumb(path) {
            const $breadcrumb = $('#breadcrumb');
            $breadcrumb.empty();
            
            const parts = path.split('/').filter(p => p);
            let currentPath = '';
            
            // 添加根目录
            $breadcrumb.append('<span>当前路径：</span>');
            $breadcrumb.append('<a href="#" data-path="/">根目录</a>');
            
            // 添加路径部分
            parts.forEach(part => {
                currentPath += '/' + part;
                $breadcrumb.append(' / ');
                $breadcrumb.append(`<a href="#" data-path="${currentPath}">${part}</a>`);
            });
            
            // 绑定面包屑点击事件
            $('#breadcrumb a').on('click', function(e) {
                e.preventDefault();
                const targetPath = $(this).data('path');
                loadFileList(targetPath);
            });
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 文件操作按钮事件
        $('#refresh-btn').on('click', function(){
            if(isConnected){
                loadFileList(currentPath);
            } else {
                layer.msg('请先连接服务器');
            }
        });
        
        $('#upload-btn').on('click', function(){
            if(!isConnected){
                layer.msg('请先连接服务器', {icon: 0});
                return;
            }
            
            layer.open({
                type: 1,
                title: '上传文件',
                content: '<div id="upload-area" style="padding: 20px; text-align: center; border: 2px dashed #ccc; margin: 10px; border-radius: 4px;"><i class="layui-icon layui-icon-upload" style="font-size: 30px; color: #ccc;"></i><br><br>点击或拖拽文件到此处上传</div>',
                area: ['450px', '250px'],
                success: function(layero, index){
                    upload.render({
                        elem: '#upload-area',
                        url: '/api/ssh/upload',
                        method: 'POST',
                        data: {
                            host: currentServer.host,
                            port: currentServer.port,
                            username: currentServer.username,
                            password: currentServer.password,
                            remotePath: currentPath
                        },
                        before: function(obj){
                            layer.load(1);
                        },
                        done: function(res){
                            layer.closeAll('loading');
                            if(res.success){
                                layer.msg('上传成功', {icon: 1});
                                layer.close(index);
                                loadFileList(currentPath);
                            } else {
                                layer.msg('上传失败: ' + (res.message || '未知错误'), {icon: 2});
                            }
                        },
                        error: function(){
                            layer.closeAll('loading');
                            layer.msg('上传失败，请检查网络连接', {icon: 2});
                        }
                    });
                }
            });
        });
        
        $('#mkdir-btn').on('click', function(){
            if(!isConnected){
                layer.msg('请先连接服务器', {icon: 0});
                return;
            }
            
            layer.prompt({
                title: '新建文件夹',
                formType: 0,
                value: '',
                maxlength: 255
            }, function(value, index){
                if(value && value.trim()){
                    const folderName = value.trim();
                    
                    // 验证文件夹名称
                    if(/[\\/:*?"<>|]/.test(folderName)){
                        layer.msg('文件夹名称不能包含特殊字符 \\ / : * ? " < > |', {icon: 2});
                        return;
                    }
                    
                    const loadingIndex = layer.load(1);
                    
                    $.ajax({
                        url: '/api/ssh/mkdir',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            host: currentServer.host,
                            port: currentServer.port,
                            username: currentServer.username,
                            password: currentServer.password,
                            path: currentPath,
                            name: folderName
                        }),
                        success: function(res){
                            layer.close(loadingIndex);
                            if(res.success){
                                layer.msg('创建成功', {icon: 1});
                                layer.close(index);
                                loadFileList(currentPath);
                            } else {
                                layer.msg('创建失败: ' + (res.message || '未知错误'), {icon: 2});
                            }
                        },
                        error: function(xhr, status, error){
                            layer.close(loadingIndex);
                            let errorMsg = '创建失败';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMsg += ': ' + xhr.responseJSON.message;
                            } else if (xhr.status === 0) {
                                errorMsg += ': 网络连接失败';
                            } else {
                                errorMsg += ': ' + error;
                            }
                            layer.msg(errorMsg, {icon: 2});
                        }
                    });
                } else {
                    layer.msg('请输入文件夹名称', {icon: 0});
                }
            });
        });
        
        $('#disconnect-file-btn').on('click', function(){
            if(!isConnected){
                layer.msg('当前未连接任何服务器', {icon: 0});
                return;
            }
            
            layer.confirm('确定要断开与服务器 "' + currentServer.host + ':' + currentServer.port + '" 的连接吗？', {
                icon: 3,
                title: '确认断开',
                btn: ['确定', '取消']
            }, function(index){
                const loadingIndex = layer.load(1);
                
                $.ajax({
                    url: '/api/ssh/disconnect',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        host: currentServer.host,
                        port: currentServer.port,
                        username: currentServer.username
                    }),
                    success: function(res){
                        layer.close(loadingIndex);
                        if(res.success){
                            layer.msg('断开连接成功', {icon: 1});
                            isConnected = false;
                            currentServer = null;
                            currentPath = '';
                            updateConnectionStatus();
                            $('#file-list').empty();
                            $('#breadcrumb').empty();
                            
                            // 显示连接提示
                            $('#file-list').html('<div style="text-align: center; padding: 50px; color: #999;"><i class="layui-icon layui-icon-unlink" style="font-size: 48px;"></i><br><br>请先连接到服务器</div>');
                            
                            // 关闭WebSocket连接
                            if (window.terminalWebSocket) {
                                window.terminalWebSocket.close();
                                window.terminalWebSocket = null;
                            }
                        } else {
                            layer.msg('断开连接失败: ' + (res.message || '未知错误'), {icon: 2});
                        }
                    },
                    error: function(xhr, status, error){
                        layer.close(loadingIndex);
                        let errorMsg = '断开连接失败';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg += ': ' + xhr.responseJSON.message;
                        } else if (xhr.status === 0) {
                            errorMsg += ': 网络连接失败';
                        } else {
                            errorMsg += ': ' + error;
                        }
                        layer.msg(errorMsg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        });

        // 终端区域事件处理
        const $terminal = $('#terminal-output');
        
        // 点击终端区域时聚焦
        $terminal.on('click', function() {
            $(this).focus();
        });

        // 处理粘贴事件
        $terminal.on('paste', function(e) {
            e.preventDefault();
            if (!isConnected || !window.terminalWebSocket || window.terminalWebSocket.readyState !== WebSocket.OPEN) {
                return;
            }
            
            let paste = (e.clipboardData || window.clipboardData).getData('text');
            commandBuffer += paste;
            updateCurrentLine();
        });

        // 终端键盘事件
        $terminal.on('keydown', function(event) {
            // 如果终端未连接，则不处理任何按键
            if (!isConnected || !window.terminalWebSocket || window.terminalWebSocket.readyState !== WebSocket.OPEN) {
                // 允许F5刷新等系统快捷键
                if (!(event.key === 'F5' || (event.ctrlKey && event.key === 'r'))) {
                    event.preventDefault();
                }
                return;
            }

            // 处理回车键
            if (event.key === 'Enter') {
                event.preventDefault();
                
                // 显示命令和换行
                $terminal.append(commandBuffer + '\n');
                scrollToBottom();
                
                // 发送命令到后端
                window.terminalWebSocket.send(commandBuffer);
                
                // 清空命令缓冲区
                commandBuffer = "";
                return;
            }

            // 处理退格键
            if (event.key === 'Backspace') {
                event.preventDefault();
                if (commandBuffer.length > 0) {
                    // 删除最后一个字符
                    commandBuffer = commandBuffer.slice(0, -1);
                    updateCurrentLine();
                }
                return;
            }

            // 处理删除键
            if (event.key === 'Delete') {
                event.preventDefault();
                return;
            }

            // 处理左/右箭头键
            if (event.key === 'ArrowLeft' || event.key === 'ArrowRight' || 
                event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                event.preventDefault();
                return;
            }

            // 处理Tab键
            if (event.key === 'Tab') {
                event.preventDefault();
                commandBuffer += "    "; // 插入4个空格
                updateCurrentLine();
                return;
            }

            // 处理Home/End键
            if (event.key === 'Home' || event.key === 'End') {
                event.preventDefault();
                return;
            }

            // 处理字符输入（只处理可见字符）
            if (event.key.length === 1 && !event.ctrlKey && !event.altKey) {
                event.preventDefault();
                commandBuffer += event.key;
                updateCurrentLine();
                return;
            }

            // 阻止其他控制键的默认行为
            if (!(event.key === 'F5' || (event.ctrlKey && event.key === 'r'))) {
                event.preventDefault();
            }
        });

        function initWebSocket(server) {
            if (window.terminalWebSocket) {
                window.terminalWebSocket.close();
            }

            const ws = new WebSocket('ws://' + window.location.host + '/ssh-terminal');
            window.terminalWebSocket = ws;

            ws.onopen = function(event) {
                $terminal.empty(); // 清空终端
                $terminal.append('正在连接到 ' + server.host + '...\n');
                scrollToBottom();

                // 发送连接信息到后端
                const connectInfo = {
                    host: server.host,
                    port: server.port,
                    username: server.username,
                    password: server.password
                };
                ws.send(JSON.stringify(connectInfo));

                isConnected = true;
                
                // 聚焦到终端区域
                $terminal.focus();
                
                // 显示初始提示符
                appendPrompt();
            };

            ws.onmessage = function(event) {
                $terminal.append(event.data);
                scrollToBottom();
                
                // 如果收到的是换行结尾的内容，添加新提示符
                if (event.data.endsWith('\n')) {
                    appendPrompt();
                }
            };

            ws.onclose = function(event) {
                $terminal.append('\n连接已断开。\n');
                scrollToBottom();
                isConnected = false;
                window.terminalWebSocket = null;
            };

            ws.onerror = function(error) {
                $terminal.append('WebSocket错误: ' + error + '\n');
                scrollToBottom();
            };
        }

        // 更新当前行显示
        function updateCurrentLine() {
            const content = $terminal.text();
            const lines = content.split('\n');
            
            // 如果没有任何行，直接显示提示符
            if (lines.length === 0) {
                $terminal.text(currentPrompt + commandBuffer);
                scrollToBottom();
                return;
            }
            
            // 更新最后一行（当前行）
            lines[lines.length - 1] = currentPrompt + commandBuffer;
            $terminal.text(lines.join('\n'));
            scrollToBottom();
        }

        // 添加提示符
        function appendPrompt() {
            // 构造提示符，类似 root@server_name:~#
            currentPrompt = currentServer.username + "@" + currentServer.name + ":~# ";
            $terminal.append(currentPrompt);
            commandBuffer = "";
            scrollToBottom();
        }

        // 滚动到底部
        function scrollToBottom() {
            $terminal.scrollTop($terminal[0].scrollHeight);
        }
        
        // 页面初始化
        $(document).ready(function() {
            // 初始化连接状态
            updateConnectionStatus(false);
            updateFileOperationButtons();
            
            // 默认显示添加服务器面板
            showAddServerPanel();
            
            // 加载服务器列表
            loadServers();
            
            // 设置默认端口
            $('#port').val('22');
        });
        
        // 初始化完成后的处理
        function initComplete() {
            console.log('文件管理模块初始化完成');
        }
        
        // 删除文件或文件夹
        function deleteFile(fileName, fileType) {
            const fileTypeText = fileType === 'directory' ? '文件夹' : '文件';
            layer.confirm('确定要删除' + fileTypeText + ' "' + fileName + '" 吗？', {
                icon: 3,
                title: '确认删除',
                btn: ['确定', '取消']
            }, function(index) {
                const loadingIndex = layer.load(1);
                
                $.ajax({
                    url: '/api/ssh/delete',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        host: currentServer.host,
                        port: currentServer.port,
                        username: currentServer.username,
                        password: currentServer.password,
                        path: currentPath + '/' + fileName
                    }),
                    success: function(res) {
                        layer.close(loadingIndex);
                        if(res.success) {
                            layer.msg('删除成功', {icon: 1});
                            loadFileList(currentPath);
                        } else {
                            layer.msg('删除失败: ' + (res.message || '未知错误'), {icon: 2});
                        }
                    },
                    error: function(xhr, status, error) {
                        layer.close(loadingIndex);
                        let errorMsg = '删除失败';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg += ': ' + xhr.responseJSON.message;
                        } else if (xhr.status === 0) {
                            errorMsg += ': 网络连接失败';
                        } else {
                            errorMsg += ': ' + error;
                        }
                        layer.msg(errorMsg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        }
        
        // 重命名文件或文件夹
        function renameFile(fileName) {
            layer.prompt({
                title: '重命名',
                formType: 0,
                value: fileName,
                maxlength: 255
            }, function(value, index) {
                if(value && value.trim() && value.trim() !== fileName) {
                    const newName = value.trim();
                    
                    // 验证文件名
                    if(/[\\/:*?"<>|]/.test(newName)){
                        layer.msg('文件名不能包含特殊字符 \\ / : * ? " < > |', {icon: 2});
                        return;
                    }
                    
                    const loadingIndex = layer.load(1);
                    
                    $.ajax({
                        url: '/api/ssh/rename',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            host: currentServer.host,
                            port: currentServer.port,
                            username: currentServer.username,
                            password: currentServer.password,
                            oldPath: currentPath + '/' + fileName,
                            newPath: currentPath + '/' + newName
                        }),
                        success: function(res) {
                            layer.close(loadingIndex);
                            if(res.success) {
                                layer.msg('重命名成功', {icon: 1});
                                loadFileList(currentPath);
                            } else {
                                layer.msg('重命名失败: ' + (res.message || '未知错误'), {icon: 2});
                            }
                        },
                        error: function(xhr, status, error) {
                            layer.close(loadingIndex);
                            let errorMsg = '重命名失败';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMsg += ': ' + xhr.responseJSON.message;
                            } else if (xhr.status === 0) {
                                errorMsg += ': 网络连接失败';
                            } else {
                                errorMsg += ': ' + error;
                            }
                            layer.msg(errorMsg, {icon: 2});
                        }
                    });
                    layer.close(index);
                } else if(value && value.trim() === fileName) {
                    layer.msg('文件名未更改', {icon: 0});
                    layer.close(index);
                } else {
                    layer.msg('请输入有效的文件名', {icon: 0});
                }
            });
        }
        
        // 下载文件
        function downloadFile(fileName) {
            if(!isConnected || !currentServer) {
                layer.msg('请先连接服务器', {icon: 0});
                return;
            }
            
            const loadingIndex = layer.load(1, {
                shade: [0.1,'#fff']
            });
            
            // 构造下载URL
            const downloadUrl = '/api/ssh/download?' + $.param({
                host: currentServer.host,
                port: currentServer.port,
                username: currentServer.username,
                password: currentServer.password,
                path: currentPath + '/' + fileName
            });
            
            // 创建隐藏的下载链接
            const $downloadLink = $('<a>');
            $downloadLink.attr('href', downloadUrl);
            $downloadLink.attr('download', fileName);
            $downloadLink.css('display', 'none');
            $('body').append($downloadLink);
            
            // 触发下载
            $downloadLink[0].click();
            
            // 清理
            setTimeout(() => {
                $downloadLink.remove();
                layer.close(loadingIndex);
            }, 1000);
            
            layer.msg('开始下载文件: ' + fileName, {icon: 1});
        }
        
        // 查看文件内容
        function viewFile(fileName) {
            if(!isConnected || !currentServer) {
                layer.msg('请先连接服务器', {icon: 0});
                return;
            }
            
            const loadingIndex = layer.load(1);
            
            $.ajax({
                url: '/api/ssh/view',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    host: currentServer.host,
                    port: currentServer.port,
                    username: currentServer.username,
                    password: currentServer.password,
                    path: currentPath + '/' + fileName
                }),
                success: function(res) {
                    layer.close(loadingIndex);
                    if(res.success) {
                        layer.open({
                            type: 1,
                            title: '查看文件: ' + fileName,
                            content: '<div style="padding: 15px;"><pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">' + $('<div>').text(res.data).html() + '</pre></div>',
                            area: ['80%', '70%'],
                            maxmin: true
                        });
                    } else {
                        layer.msg('查看文件失败: ' + (res.message || '未知错误'), {icon: 2});
                    }
                },
                error: function(xhr, status, error) {
                    layer.close(loadingIndex);
                    let errorMsg = '查看文件失败';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg += ': ' + xhr.responseJSON.message;
                    } else if (xhr.status === 0) {
                        errorMsg += ': 网络连接失败';
                    } else {
                        errorMsg += ': ' + error;
                    }
                    layer.msg(errorMsg, {icon: 2});
                }
            });
        }
        
        // 调用初始化
        initComplete();
    });
</script>
</body>
</html>